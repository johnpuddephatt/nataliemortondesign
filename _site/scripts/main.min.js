!function(){for(var e,n=function(){},o=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],i=o.length,r=window.console=window.console||{};i--;)e=o[i],r[e]||(r[e]=n)}();

var pckry;

var body = document.querySelector('body'),

    pins_per_page = 20,
    current_pins = pins_per_page,
    postContainer = document.querySelector('.pins'),
    ajaxButton = document.querySelector('.load-more'),
    loadingSpinner = document.querySelector('.loading-spinner'),
    pins = document.querySelectorAll('.pin'),
    infiniteRequest = new XMLHttpRequest();
    infiniteRequest.responseType = 'json';

    loadingSpinner.classList.add('loading');
//postContainer.classList.add('loading');

var imgLoad = imagesLoaded( '.pins', function() {
  pckry = new Packery( '.pins', {
    itemSelector: '.pin',
    transitionDuration: 0
  });

  document.addEventListener('scroll', function(){
    var scrollGap = document.documentElement.offsetHeight - ((window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0) + window.innerHeight);
    console.log(scrollGap);
    if(scrollGap == 0 && ( infiniteRequest.readyState == 4 | infiniteRequest.readyState == 0 )) {
      infiniteRequest.open('GET', 'posts.json' , true);
      infiniteRequest.send();
    }
  })

});

imgLoad.on( 'progress', function( instance, image ) {
  image.img.parentNode.classList.remove('loading');
});

imgLoad.on( 'always', function( instance ) {
  loadingSpinner.classList.remove('loading');
});

infiniteRequest.onload = function() {
  if (infiniteRequest.status >= 200 && infiniteRequest.status < 400) {
      // Success!
      var data = infiniteRequest.response;
      var pinpen = [];
      loadingSpinner.classList.add('loading');
      for (var i = (current_pins - pins_per_page); Math.min(current_pins,data.length) > i; i++) {
        var li = document.createElement("li");
        li.classList.add('pin');
        if(data[i].is_featured ) {
          li.classList.add('featured');
        }
        var img = document.createElement("img");
        img.setAttribute('src',data[i].image);
        var anchor = document.createElement("a");
        anchor.setAttribute('href', data[i].url)
        anchor.classList.add('loading');
        var description = document.createElement("div");
        description.classList.add('pin-description');
        var title = document.createElement("h2");
        title.classList.add('pin-title');
        var titleText = document.createTextNode(data[i].title);
        var content = document.createElement("p");
        content.innerHTML = data[i].content;
        description.appendChild(title).appendChild(titleText);
        description.appendChild(content);
        anchor.appendChild(img);
        anchor.appendChild(description);
        li.appendChild(anchor);
        pinpen.push(li)
      }
      for (var i = 0; pinpen.length > i; i++) {
        postContainer.appendChild(pinpen[i]);
      }
      var imgLoad2 = imagesLoaded( '.pins', function() {
        pckry.appended( pinpen );
        pckry.layout();
        loadingSpinner.classList.remove('loading');
      });
      imgLoad2.on( 'progress', function( instance, image ) {
        image.img.parentNode.classList.remove('loading');
      });
      current_pins += pins_per_page
      pins = document.querySelectorAll('.pin');
  } else {
    //
  }
};


infiniteRequest.onerror = function() {
  // There was a connection error of some sort...
};

postContainer.addEventListener('click', function(e){

  if (e.target !== e.currentTarget) {
    enlargedElem = e.target.parentNode.parentNode;
    if (enlargedElem.classList.contains("open")) {
      enlargedElem.classList.remove('open');
    }
    else {
      for( var i=0; i < pins.length; i++ ) {
        pins[i].classList.remove('open');
      }
      enlargedElem = e.target.parentNode.parentNode;
      enlargedElem.classList.add('open');

    }
    pckry.layout();
    smoothScroll(enlargedElem);
    e.preventDefault();
    e.stopPropagation();
  }
})


